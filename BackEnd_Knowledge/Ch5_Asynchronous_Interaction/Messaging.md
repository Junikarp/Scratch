# 메시징
> 서로 다른 시스템 간 연동이 필요할 때 메시징 시스템을 이용 가능하다. <br>
> 주요 메시징 시스템에 사용되는 기술들에는 Kafka, RabbitMQ, Redis pub/sub 등이 있다.

## 메시징 시스템 장점
1. 메시징 시스템을 사용하면 두 시스템이 서로 영향을 주지 않는다.
    * 시스템 사이에 메시징 시스템을 거쳐 연동되기 때문
2. 시스템의 확장이 용이하다.
    * 시스템을 확장하고 싶다면 새로운 시스템을 메시징 시스템에 연결만 하면 된다.
    * 기존 시스템의 코드 수정이 필요가 없다는 것

## 주요 메시징 시스템
> 메시지가 유실되어도 상관없고 간단한 사용법 -> Redis pub/sub <br>
> 트래픽이 대량 (초당 수 십만~ 초당 수백만) 으로 발생함 -> Kafka <br>
> 트래픽 규모가 크지않고 정확한 순서 필요, 혹은 AMQP, STOMP 프로토콜 연동 필요 -> RabbitMQ

### Kafka (카프카)
* 초당 백 만 개 이상의 메시지를 처리할만큼 높은 처리량
* 수평 확장에 용이 -> 서버(브로커), 파티션, 소비자를 늘리면 됨
* 메시지를 파일에 보관하므로 메시지가 유실되지 않음
* 1개의 토픽은 여러개의 파티션으로 구성 -> 파티션 단위의 순서보장, 하지만 토픽 수준 순서 보장은 X
* 소비자가 메시지를 언제든지 재처리 가능
* 소비자가 카프카 브로커에서 메시지를 읽어가는 pull 모델 사용

### RabbitMQ (래빗MQ)
* 클러스터를 통해 처리량 증가 가능 -> 카프카 보다 더 많은 자원 필요
* 메모리에만 메시지를 보관하는 큐 설정 시, 장애 상황에서 메시지 유실 가능
* 메시지는 큐에 등록된 순서대로 소비자에게 전송
* 메시지가 소비자에게 전달됐는지 확인하는 기능 제공
* push 모델을 사용 -> 래빗MQ 브로커가 소비자에게 메시지를 전송 -> 소비자의 성능이 느려지면 과부하로 전반적 성능 저하 발생
* AMQP, STOMP 등 여러 프로토콜을 지원, 게시/구독 패턴, 요청/응답, 점대점패턴 지원 (지원하는 기능 많음)
* 우선순위를 지정해 처리순서 변경 가능

### Redis pub/sub
* 메모리를 사용하므로 지연시간 짧음
* RabbitMQ 보다 높은 처리량
* 구독자가 없으면 메시지가 유실
* 기본적으로 영구 메시지를 지원하지 않음
* 모델이 단순 -> 사용이 쉬움

추가로 AWS SQS, NATS, 액티브MQ, 로켓MQ 등 여러 메시징 시스템이 있다. 장단점 이외에도 자신의 기술적 경험등을 토대로 기술을 결정할 것

## 메시지 생성 시 고려 사항
메시지 생성시 고려할 점은 메시지 유실과 연관된다. 메시지 유실 및 오류 처리 시 3가지 방법을 선택 가능하다.
1. 무시 (유실되어도 괜찮거나 치명적이지 않은 오류)
2. 재시도 (네트워크 오류 등 -> 대신 중복 수신 방지 처리 등 고려해야함)
3. 실패 로그 남기기 (후처리에 활용)

또한 메시지 생산자는 DB 트랜잭션과의 연동을 고려해야한다 -> 트랜잭션 실패시 메시지가 발송되면 잘못된 데이터를 전달할 수 있기 때문이다. 따라서 트랜잭션이 끝난 뒤에 메시지를 전송해야 한다.