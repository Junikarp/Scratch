# 추가 고려 가능 사항들
> 추가적으로 고려하면 좋은 방안들 입니다.

---
## 쿼리 타임 아웃
> 응답 지연으로 인한 재시도를 예방하기 위해 적절한 쿼리 타임 아웃이 필요하다.
> 보통 블로그 조회와 같은 쿼리 타임아웃은 짧게 잡아도 되지만 결제 기능과 같이 데이터 정합성이 중요한 작업은 조금 길게 잡는다.

---
## 주 DB - 복제 DB 사용시 주의점
> 상태 변경 기능은 복제 DB 에서 조회하지 말자

주 DB - 복제 DB 는 모든 SELECT 를 복제 DB 에서 처리하는 구조가 아니다.
모든 SELECT 를 복제 DB 에서 처리하게 할 때 문제가 2가지 생길 수 있기 때문

1. 주 DB 와 복제 DB 의 데이터가 일치하지 않을 수 있다.
   * 데이터 복제에 시간이 걸리므로 일시적으로 다른 값을 가질 수 있기 때문
   * 즉 데이터가 복제 DB 에 반영되기 이전에 SELECT 하면 잘못된 데이터를 조회할 가능성이 있다.
2. 트랜잭션 문제가 발생 가능하다.
   * 주 DB 와 복제 DB 간 데이터 복제는 트랜잭션 커밋 시점에 이루어진다.
   * 즉 트랜잭션 범위 내에서 데이터를 변경하고, 복제 DB 에서 변경 대상이 될 수 있는 데이터를 조회하면 데이터가 불일치한다.

회원가입을 예시로 들어보자. 만약 어떤 유저가 회원가입을 진행한 후에 바로 로그인을 시도하려고 한다.
하지만 복제 DB 에는 해당 유저의 회원정보가 복제되기 이전이므로 복제 DB 에서 SELECT 했을 시 로그인에 문제가 발생한다.
때문에 이런 경우 주 DB 에서 정보를 가져와야 한다. (비동기식 복제에서 발생하는 문제다. 하지만 동기식 복제를 사용해도 시간이 오래걸린다는 단점이 존재한다.)

---
## 배치 쿼리 실행 시간 증가
> 배치 프로그램은 데이터를 일괄로 조회, 생성, 집계하는 작업이다.
> 한번에 조회하고 집계하는 데이터가 많아질수록 일괄 처리용 쿼리의 실행시간도 함께 증가한다.

집계 쿼리는 어느 순간 실행시간이 기하급수적으로 늘어날 수 있다. 이를 예방하기 위해 아래와 같은 해결책을 고려해볼만 하다.

1. DB 장비의 사양을 높히기
2. 커버링 인덱스를 활용
3. 데이터를 일정 크기로 나눠서 처리

이전에 사용자 통계 파트를 개발할 일이 있었다. 이 때 많은 데이터의 통계값을 나타내고 조회해야 하는 과제가 주어졌는데 이 때 한번에 데이터를 조회하지 않고,
일별로 끊어서 집계하는 방식이 효과적이었다.

---
## 타입이 다른 컬럼 조인 주의
> 컬럼의 타입이 다르면 타입 캐스팅에 불필요한 자원이 소모될 수 있다.
> 컬럼의 타입이 다르면 인덱스를 활용하는 것도 불가하다.
> 따라서 미리 컬럼의 타입을 cast 등으로 맞춰주는 것이 필요하다.

---
## 테이블 변경 시 주의
> DB 는 테이블 변경시 새 테이블을 생성 후 원본 테이블을 복사한 뒤 복사된 테이블로 원본을 대체한다.
> 이 과정에서 복사 시간만큼 DML 을 허용하지 않으므로 서비스가 중단된다.
> 따라서 이러한 작업 시에는 점검 시간을 가지고 변경하는 경우가 많다.

--- 
## DB 최대 연결 개수
> DB 의 연결 개수가 API 서버의 커넥션 수보다 적으면 연결 실패가 발생 가능하다.
> 따라서 필요한 적절한 DB 최대 연결 개수를 설정해야 한다.
> 단, DB 서버의 CPU 사용률이 70% 이상이라면 늘리면 안된다.(DB 부하로 인한 성능 저하 발생 가능 -> 이 때는 캐시서버, 쿼리 튜닝 등 고려)

---
## 실패와 트랜잭션 고려
> DB 관련 코드에서는 트랜잭션 시작과 종료 경계가 명확해야 한다.